<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Magic E Rhyme Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            keyframes: {
              shake: {
                '0%, 100%': { transform: 'translateX(0)' },
                '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-10px)' },
                '20%, 40%, 60%, 80%': { transform: 'translateX(10px)' },
              },
            },
            animation: {
              shake: 'shake 0.5s ease-in-out',
            },
          },
        },
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://aistudiocdn.com/react@^19.2.0",
          "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client"
        }
      }
    </script>
  </head>
  <body class="bg-slate-100 dark:bg-slate-900">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React from 'react';
      import ReactDOM from 'react-dom/client';

      const { useState, useEffect, useMemo, useCallback, StrictMode } = React;

      // From types.ts
      const GameState = {
        Start: 'Start',
        Playing: 'Playing',
        Finished: 'Finished',
        Retrying: 'Retrying'
      };

      // From services/data.ts
      const wordData = [
        {
          groupName: '\"Họ\" Vần A-E (Tạo âm /ei/ - \"ây\")',
          explanation: 'Nguyên âm "a" đi với "e câm" ở cuối sẽ tạo ra âm /eɪ/, nghe giống như "ây" trong tiếng Việt.',
          rhymeFamilies: [
            { rhyme: '-ace', pronunciationDisplay: '/eis/', pronunciationSpeakable: 'ace', words: [{ text: 'face', translation: 'khuôn mặt' }, { text: 'place', translation: 'nơi chốn' }, { text: 'race', translation: 'cuộc đua' }, { text: 'space', translation: 'không gian' }, { text: 'grace', translation: 'duyên dáng' }] },
            { rhyme: '-ade', pronunciationDisplay: '/eid/', pronunciationSpeakable: 'ade', words: [{ text: 'made', translation: 'đã làm' }, { text: 'grade', translation: 'khối lớp' }, { text: 'trade', translation: 'giao dịch' }, { text: 'fade', translation: 'phai màu' }, { text: 'blade', translation: 'lưỡi dao' }] },
            { rhyme: '-age', pronunciationDisplay: '/eidʒ/', pronunciationSpeakable: 'age', words: [{ text: 'cage', translation: 'cái lồng' }, { text: 'page', translation: 'trang sách' }, { text: 'wage', translation: 'lương' }, { text: 'stage', translation: 'sân khấu' }, { text: 'rage', translation: 'cơn giận' }] },
            { rhyme: '-ake', pronunciationDisplay: '/eik/', pronunciationSpeakable: 'ake', words: [{ text: 'cake', translation: 'bánh ngọt' }, { text: 'make', translation: 'làm' }, { text: 'take', translation: 'lấy' }, { text: 'lake', translation: 'cái hồ' }, { text: 'snake', translation: 'con rắn' }] },
            { rhyme: '-ale', pronunciationDisplay: '/eil/', pronunciationSpeakable: 'ale', words: [{ text: 'sale', translation: 'giảm giá' }, { text: 'tale', translation: 'câu chuyện' }, { text: 'male', translation: 'nam giới' }, { text: 'whale', translation: 'cá voi' }, { text: 'pale', translation: 'nhợt nhạt' }] },
            { rhyme: '-ame', pronunciationDisplay: '/eim/', pronunciationSpeakable: 'ame', words: [{ text: 'name', translation: 'tên' }, { text: 'game', translation: 'trò chơi' }, { text: 'same', translation: 'giống nhau' }, { text: 'flame', translation: 'ngọn lửa' }, { text: 'frame', translation: 'cái khung' }] },
            { rhyme: '-ane', pronunciationDisplay: '/ein/', pronunciationSpeakable: 'ane', words: [{ text: 'plane', translation: 'máy bay' }, { text: 'lane', translation: 'làn đường' }, { text: 'mane', translation: 'bờm ngựa' }, { text: 'cane', translation: 'cây gậy' }, { text: 'crane', translation: 'cần cẩu' }] },
            { rhyme: '-ape', pronunciationDisplay: '/eip/', pronunciationSpeakable: 'ape', words: [{ text: 'grape', translation: 'quả nho' }, { text: 'shape', translation: 'hình dạng' }, { text: 'tape', translation: 'băng keo' }, { text: 'cape', translation: 'áo choàng' }, { text: 'drape', translation: 'rèm cửa' }] },
            { rhyme: '-ate', pronunciationDisplay: '/eit/', pronunciationSpeakable: 'ate', words: [{ text: 'late', translation: 'muộn' }, { text: 'date', translation: 'ngày tháng' }, { text: 'gate', translation: 'cái cổng' }, { text: 'hate', translation: 'ghét' }, { text: 'state', translation: 'tiểu bang' }] },
            { rhyme: '-ave', pronunciationDisplay: '/eiv/', pronunciationSpeakable: 'ave', words: [{ text: 'save', translation: 'lưu, cứu' }, { text: 'wave', translation: 'làn sóng' }, { text: 'gave', translation: 'đã cho' }, { text: 'cave', translation: 'hang động' }, { text: 'brave', translation: 'dũng cảm' }] },
            { rhyme: '-ase', pronunciationDisplay: '/eis/', pronunciationSpeakable: 'ase', words: [{ text: 'case', translation: 'trường hợp' }, { text: 'base', translation: 'căn cứ' }, { text: 'vase', translation: 'lọ hoa' }] },
            { rhyme: '-aze', pronunciationDisplay: '/eiz/', pronunciationSpeakable: 'aze', words: [{ text: 'maze', translation: 'mê cung' }, { text: 'gaze', translation: 'nhìn chằm chằm' }] }
          ],
        },
        {
          groupName: '\"Họ\" Vần I-E (Tạo âm /aɪ/ - \"ai\")',
          explanation: 'Nguyên âm "i" đi với "e câm" ở cuối sẽ tạo ra âm /aɪ/, nghe giống như "ai" trong tiếng Việt.',
          rhymeFamilies: [
            { rhyme: '-ice', pronunciationDisplay: '/ais/', pronunciationSpeakable: 'ice', words: [{ text: 'rice', translation: 'cơm, gạo' }, { text: 'nice', translation: 'tốt đẹp' }, { text: 'mice', translation: 'những con chuột' }, { text: 'price', translation: 'giá cả' }, { text: 'slice', translation: 'lát mỏng' }] },
            { rhyme: '-ide', pronunciationDisplay: '/aid/', pronunciationSpeakable: 'ide', words: [{ text: 'ride', translation: 'cưỡi, đi xe' }, { text: 'hide', translation: 'trốn' }, { text: 'side', translation: 'bên cạnh' }, { text: 'wide', translation: 'rộng' }, { text: 'slide', translation: 'cầu trượt' }] },
            { rhyme: '-ife', pronunciationDisplay: '/aif/', pronunciationSpeakable: 'ife', words: [{ text: 'life', translation: 'cuộc sống' }, { text: 'wife', translation: 'người vợ' }, { text: 'knife', translation: 'con dao' }, { text: 'strife', translation: 'xung đột' }] },
            { rhyme: '-ike', pronunciationDisplay: '/aik/', pronunciationSpeakable: 'ike', words: [{ text: 'bike', translation: 'xe đạp' }, { text: 'like', translation: 'thích' }, { text: 'hike', translation: 'đi bộ' }, { text: 'strike', translation: 'đình công, đánh' }] },
            { rhyme: '-ile', pronunciationDisplay: '/ail/', pronunciationSpeakable: 'ile', words: [{ text: 'file', translation: 'tệp' }, { text: 'smile', translation: 'mỉm cười' }, { text: 'tile', translation: 'gạch lát' }, { text: 'while', translation: 'trong khi' }, { text: 'pile', translation: 'một đống' }] },
            { rhyme: '-ime', pronunciationDisplay: '/aim/', pronunciationSpeakable: 'ime', words: [{ text: 'time', translation: 'thời gian' }, { text: 'lime', translation: 'quả chanh' }, { text: 'crime', translation: 'tội ác' }, { text: 'prime', translation: 'nguyên tố' }, { text: 'chime', translation: 'chuông gió' }] },
            { rhyme: '-ine', pronunciationDisplay: '/ain/', pronunciationSpeakable: 'eye-n', words: [{ text: 'nine', translation: 'số 9' }, { text: 'line', translation: 'đường kẻ' }, { text: 'fine', translation: 'tốt, ổn' }, { text: 'dine', translation: 'ăn tối' }, { text: 'shine', translation: 'chiếu sáng' }] },
            { rhyme: '-ipe', pronunciationDisplay: '/aip/', pronunciationSpeakable: 'ipe', words: [{ text: 'wipe', translation: 'lau chùi' }, { text: 'pipe', translation: 'cái ống' }, { text: 'ripe', translation: 'chín (trái cây)' }, { text: 'stripe', translation: 'sọc vằn' }] },
            { rhyme: '-ite', pronunciationDisplay: '/ait/', pronunciationSpeakable: 'ite', words: [{ text: 'bite', translation: 'cắn' }, { text: 'kite', translation: 'con diều' }, { text: 'white', translation: 'màu trắng' }, { text: 'quite', translation: 'khá là' }, { text: 'site', translation: 'địa điểm' }] },
            { rhyme: '-ive', pronunciationDisplay: '/aiv/', pronunciationSpeakable: 'eye-v', words: [{ text: 'five', translation: 'số 5' }, { text: 'dive', translation: 'lặn' }, { text: 'drive', translation: 'lái xe' }, { text: 'hive', translation: 'tổ ong' }, { text: 'alive', translation: 'còn sống' }] },
            { rhyme: '-ize', pronunciationDisplay: '/aiz/', pronunciationSpeakable: 'ize', words: [{ text: 'size', translation: 'kích cỡ' }, { text: 'prize', translation: 'giải thưởng' }, { text: 'wise', translation: 'khôn ngoan' }] },
            { rhyme: '-ire', pronunciationDisplay: '/aɪər/', pronunciationSpeakable: 'ire', words: [{ text: 'fire', translation: 'lửa' }, { text: 'tire', translation: 'lốp xe' }, { text: 'wire', translation: 'dây điện' }, { text: 'hire', translation: 'thuê' }] }
          ],
        },
        {
          groupName: '\"Họ\" Vần O-E (Tạo âm /oʊ/ - \"âu\")',
          explanation: 'Nguyên âm "o" đi với "e câm" ở cuối sẽ tạo ra âm /oʊ/, nghe giống như "âu" trong tiếng Việt.',
          rhymeFamilies: [
              { rhyme: '-oke', pronunciationDisplay: '/oʊk/', pronunciationSpeakable: 'oke', words: [{ text: 'joke', translation: 'trò đùa' }, { text: 'smoke', translation: 'khói' }, { text: 'woke', translation: 'đã thức' }, { text: 'spoke', translation: 'đã nói' }, { text: 'broke', translation: 'đã vỡ' }] },
              { rhyme: '-ole', pronunciationDisplay: '/oʊl/', pronunciationSpeakable: 'ole', words: [{ text: 'hole', translation: 'cái lỗ' }, { text: 'pole', translation: 'cái cột' }, { text: 'mole', translation: 'chuột chũi' }, { text: 'stole', translation: 'đã lấy trộm' }, { text: 'whole', translation: 'toàn bộ' }] },
              { rhyme: '-ome', pronunciationDisplay: '/oʊm/', pronunciationSpeakable: 'ome', words: [{ text: 'home', translation: 'nhà' }, { text: 'dome', translation: 'mái vòm' }, { text: 'chrome', translation: 'crôm' }] },
              { rhyme: '-one', pronunciationDisplay: '/oʊn/', pronunciationSpeakable: 'own', words: [{ text: 'bone', translation: 'xương' }, { text: 'stone', translation: 'hòn đá' }, { text: 'phone', translation: 'điện thoại' }, { text: 'zone', translation: 'khu vực' }, { text: 'alone', translation: 'một mình' }] },
              { rhyme: '-ope', pronunciationDisplay: '/oʊp/', pronunciationSpeakable: 'ope', words: [{ text: 'hope', translation: 'hy vọng' }, { text: 'rope', translation: 'dây thừng' }, { text: 'slope', translation: 'con dốc' }, { text: 'scope', translation: 'phạm vi' }] },
              { rhyme: '-ose', pronunciationDisplay: '/oʊz/', pronunciationSpeakable: 'ose', words: [{ text: 'rose', translation: 'hoa hồng' }, { text: 'nose', translation: 'cái mũi' }, { text: 'those', translation: 'những cái đó' }, { text: 'close', translation: 'đóng' }, { text: 'pose', translation: 'tạo dáng' }] },
              { rhyme: '-ote', pronunciationDisplay: '/oʊt/', pronunciationSpeakable: 'ote', words: [{ text: 'note', translation: 'ghi chú' }, { text: 'vote', translation: 'bỏ phiếu' }, { text: 'quote', translation: 'trích dẫn' }, { text: 'wrote', translation: 'đã viết' }] },
              { rhyme: '-ore', pronunciationDisplay: '/ɔ:r/', pronunciationSpeakable: 'ore', words: [{ text: 'more', translation: 'nhiều hơn' }, { text: 'store', translation: 'cửa hàng' }, { text: 'score', translation: 'điểm số' }, { text: 'bore', translation: 'chán' }, { text: 'shore', translation: 'bờ biển' }] }
          ],
        },
        {
          groupName: '\"Họ\" Vần U-E (Tạo âm /u:/ hoặc /ju:/)',
          explanation: 'Nguyên âm "u" đi với "e câm" ở cuối sẽ tạo ra âm /u:/ (u dài) hoặc /ju:/.',
          rhymeFamilies: [
            { rhyme: '-ube', pronunciationDisplay: '/u:b/ /ju:b/', pronunciationSpeakable: 'ube', words: [{ text: 'tube', translation: 'cái ống' }, { text: 'cube', translation: 'khối lập phương' }] },
            { rhyme: '-ude', pronunciationDisplay: '/u:d/', pronunciationSpeakable: 'ude', words: [{ text: 'rude', translation: 'thô lỗ' }, { text: 'dude', translation: 'anh bạn' }, { text: 'include', translation: 'bao gồm' }] },
            { rhyme: '-ule', pronunciationDisplay: '/u:l/ /ju:l/', pronunciationSpeakable: 'ule', words: [{ text: 'rule', translation: 'quy tắc' }, { text: 'mule', translation: 'con la' }] },
            { rhyme: '-une', pronunciationDisplay: '/u:n/ /ju:n/', pronunciationSpeakable: 'une', words: [{ text: 'June', translation: 'tháng 6' }, { text: 'tune', translation: 'giai điệu' }, { text: 'prune', translation: 'cắt tỉa' }] },
            { rhyme: '-use', pronunciationDisplay: '/u:z/ /ju:z/', pronunciationSpeakable: 'use', words: [{ text: 'use', translation: 'sử dụng' }, { text: 'fuse', translation: 'cầu chì' }, { text: 'refuse', translation: 'từ chối' }, { text: 'confuse', translation: 'bối rối' }, { text: 'excuse', translation: 'lý do' }] },
            { rhyme: '-ute', pronunciationDisplay: '/u:t/ /ju:t/', pronunciationSpeakable: 'ute', words: [{ text: 'cute', translation: 'dễ thương' }, { text: 'mute', translation: 'tắt tiếng' }, { text: 'flute', translation: 'cây sáo' }] },
            { rhyme: '-ure', pronunciationDisplay: '/jʊər/', pronunciationSpeakable: 'ure', words: [{ text: 'cure', translation: 'chữa trị' }, { text: 'pure', translation: 'tinh khiết' }, { text: 'lure', translation: 'thu hút' }] }
          ],
        },
        {
          groupName: '\"Họ\" Vần E-E (Tạo âm /i:/ - \"i-dài\")',
          explanation: 'Vần E-E (hai chữ e đi liền nhau) thường tạo ra âm /i:/, nghe giống như "i" kéo dài.',
          rhymeFamilies: [
            { rhyme: '-eme', pronunciationDisplay: '/i:m/', pronunciationSpeakable: 'eme', words: [{ text: 'theme', translation: 'chủ đề' }] },
            { rhyme: '-ene', pronunciationDisplay: '/i:n/', pronunciationSpeakable: 'ene', words: [{ text: 'scene', translation: 'cảnh' }, { text: 'gene', translation: 'gen di truyền' }, { text: 'extreme', translation: 'cực đoan' }] },
            { rhyme: '-ete', pronunciationDisplay: '/i:t/', pronunciationSpeakable: 'ete', words: [{ text: 'Pete', translation: 'tên người' }, { text: 'delete', translation: 'xóa' }, { text: 'complete', translation: 'hoàn thành' }, { text: 'concrete', translation: 'bê tông' }] },
            { rhyme: '-ere', pronunciationDisplay: '/ɪər/', pronunciationSpeakable: 'ere', words: [{ text: 'here', translation: 'ở đây' }, { text: 'sphere', translation: 'hình cầu' }, { text: 'atmosphere', translation: 'bầu khí quyển' }] }
          ],
        },
        {
          groupName: '"Họ" Vần CVC A (Tạo âm /æ/ - "a-ngắn")',
          explanation: 'Nguyên âm "a" trong cấu trúc CVC (Phụ âm-Nguyên âm-Phụ âm) tạo ra âm /æ/ ngắn.',
          rhymeFamilies: [
            { rhyme: '-ap', pronunciationDisplay: '/æp/', pronunciationSpeakable: 'ap', words: [{ text: 'cap', translation: 'mũ' }] },
            { rhyme: '-at', pronunciationDisplay: '/æt/', pronunciationSpeakable: 'at', words: [{ text: 'rat', translation: 'chuột' }] },
            { rhyme: '-ad', pronunciationDisplay: '/æd/', pronunciationSpeakable: 'ad', words: [{ text: 'mad', translation: 'giận' }] },
            { rhyme: '-an', pronunciationDisplay: '/æn/', pronunciationSpeakable: 'an', words: [{ text: 'man', translation: 'người' }] },
            { rhyme: '-am', pronunciationDisplay: '/æm/', pronunciationSpeakable: 'am', words: [{ text: 'sam', translation: 'tên' }] },
          ],
        },
        {
          groupName: '"Họ" Vần CVC I (Tạo âm /ɪ/ - "i-ngắn")',
          explanation: 'Nguyên âm "i" trong cấu trúc CVC (Phụ âm-Nguyên âm-Phụ âm) tạo ra âm /ɪ/ ngắn.',
          rhymeFamilies: [
            { rhyme: '-it', pronunciationDisplay: '/ɪt/', pronunciationSpeakable: 'it', words: [{ text: 'bit', translation: 'mẩu' }] },
            { rhyme: '-id', pronunciationDisplay: '/ɪd/', pronunciationSpeakable: 'id', words: [{ text: 'rid', translation: 'thoát' }] },
            { rhyme: '-in', pronunciationDisplay: '/ɪn/', pronunciationSpeakable: 'in', words: [{ text: 'pin', translation: 'ghim' }] },
            { rhyme: '-ip', pronunciationDisplay: '/ɪp/', pronunciationSpeakable: 'ip', words: [{ text: 'rip', translation: 'xé' }] },
            { rhyme: '-im', pronunciationDisplay: '/ɪm/', pronunciationSpeakable: 'im', words: [{ text: 'dim', translation: 'mờ' }] },
          ],
        },
        {
          groupName: '"Họ" Vần CVC O (Tạo âm /ɒ/ - "o-ngắn")',
          explanation: 'Nguyên âm "o" trong cấu trúc CVC (Phụ âm-Nguyên âm-Phụ âm) tạo ra âm /ɒ/ ngắn.',
          rhymeFamilies: [
            { rhyme: '-op', pronunciationDisplay: '/ɒp/', pronunciationSpeakable: 'ahp', words: [{ text: 'hop', translation: 'nhảy' }] },
            { rhyme: '-ot', pronunciationDisplay: '/ɒt/', pronunciationSpeakable: 'aht', words: [{ text: 'not', translation: 'không' }] },
            { rhyme: '-od', pronunciationDisplay: '/ɒd/', pronunciationSpeakable: 'ahd', words: [{ text: 'rod', translation: 'que' }] },
            { rhyme: '-ob', pronunciationDisplay: '/ɒb/', pronunciationSpeakable: 'ahb', words: [{ text: 'rob', translation: 'cướp' }] },
            { rhyme: '-on', pronunciationDisplay: '/ɒn/', pronunciationSpeakable: 'ahn', words: [{ text: 'con', translation: 'lừa' }] },
          ],
        },
        {
          groupName: '"Họ" Vần CVC U (Tạo âm /ʌ/ - "u-ngắn")',
          explanation: 'Nguyên âm "u" trong cấu trúc CVC (Phụ âm-Nguyên âm-Phụ âm) tạo ra âm /ʌ/.',
          rhymeFamilies: [
            { rhyme: '-ub', pronunciationDisplay: '/ʌb/', pronunciationSpeakable: 'uhb', words: [{ text: 'cub', translation: 'gấu con' }] },
            { rhyme: '-ut', pronunciationDisplay: '/ʌt/', pronunciationSpeakable: 'uht', words: [{ text: 'cut', translation: 'cắt' }] },
            { rhyme: '-us', pronunciationDisplay: '/ʌs/', pronunciationSpeakable: 'us', words: [{ text: 'us', translation: 'chúng ta' }] },
            { rhyme: '-un', pronunciationDisplay: '/ʌn/', pronunciationSpeakable: 'uhn', words: [{ text: 'run', translation: 'chạy' }] },
            { rhyme: '-ud', pronunciationDisplay: '/ʌd/', pronunciationSpeakable: 'uhd', words: [{ text: 'bud', translation: 'nụ hoa' }] },
          ],
        },
      ];

      // From services/ttsService.ts
      const ttsService = {
        getVoices: () => {
          return new Promise((resolve) => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length) {
              resolve(voices);
              return;
            }
            window.speechSynthesis.onvoiceschanged = () => {
              resolve(window.speechSynthesis.getVoices());
            };
          });
        },

        speak: (text, voice, rate = 0.9, pitch = 1) => {
          if (!text || typeof window === 'undefined' || !window.speechSynthesis) {
              return;
          }
          
          const utterance = new SpeechSynthesisUtterance(text);
          if (voice) {
            utterance.voice = voice;
          }
          utterance.lang = 'en-US';
          utterance.rate = rate;
          utterance.pitch = pitch;
          
          window.speechSynthesis.cancel(); // Cancel any previous speech
          window.speechSynthesis.speak(utterance);
        },
      };

      // From components/icons.tsx
      const SpeakerIcon = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
        </svg>
      );

      const CheckCircleIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
      );

      const XCircleIcon = (props) => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
              <path strokeLinecap="round" strokeLinejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
      );

      // From components/WordButton.tsx
      const WordButton = ({ word, onClick, isFound, feedback }) => {
          const handleClick = () => {
              if (!isFound) {
                  onClick(word);
              }
          };

          const baseClasses = "relative flex flex-col items-center justify-center p-4 border-2 rounded-lg transition-all duration-200 text-center focus:outline-none focus:ring-2 focus:ring-violet-500 disabled:opacity-50 disabled:transform-none";
          
          let stateClasses = "bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 hover:border-violet-500 hover:bg-violet-50 dark:hover:bg-violet-900/50 cursor-pointer";
          if (isFound) {
              stateClasses = "bg-green-100 dark:bg-green-900 border-green-500 cursor-default";
          } else if (feedback === 'incorrect') {
              stateClasses = "bg-red-100 dark:bg-red-900 border-red-500 animate-shake";
          }

          return (
              <button 
                  onClick={handleClick}
                  disabled={isFound}
                  className={`${baseClasses} ${stateClasses}`}
                  aria-label={`Select word: ${word.text}`}
              >
                  <span className="text-xl md:text-2xl font-semibold">{word.text}</span>
                  <span className="text-sm text-slate-500 dark:text-slate-400">{word.translation}</span>
                  {isFound && <CheckCircleIcon className="w-6 h-6 text-green-500 absolute top-2 right-2"/>}
                  {feedback === 'incorrect' && <XCircleIcon className="w-6 h-6 text-red-500 absolute top-2 right-2"/>}
              </button>
          );
      };

      // From components/StartScreen.tsx
      const StartScreen = ({ onStart }) => {
        const [name, setName] = useState('');

        const handleSubmit = (e) => {
          e.preventDefault();
          if (name.trim()) {
            onStart(name.trim());
          }
        };

        return (
          <div className="flex flex-col items-center justify-center h-full text-center">
            <h2 className="text-3xl font-bold mb-4">Welcome!</h2>
            <p className="text-slate-600 dark:text-slate-400 mb-8 max-w-md">
              Enter your name to start your journey into mastering the "Magic E" and improving your English pronunciation.
            </p>
            <form onSubmit={handleSubmit} className="w-full max-w-sm">
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="Enter your name"
                className="w-full px-4 py-3 mb-4 text-lg border-2 border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 outline-none bg-slate-50 dark:bg-slate-700 transition"
                aria-label="Player name input"
              />
              <button
                type="submit"
                disabled={!name.trim()}
                className="w-full px-6 py-3 text-lg font-bold text-white bg-violet-600 rounded-lg hover:bg-violet-700 disabled:bg-slate-400 disabled:cursor-not-allowed transform hover:scale-105 transition-all duration-300 ease-in-out"
              >
                Start Playing
              </button>
            </form>
          </div>
        );
      };

      // From components/EndScreen.tsx
      const EndScreen = ({
        playerName,
        score,
        totalQuestions,
        mistakes,
        onPlayAgain,
        onRetryMistakes,
      }) => {
        const incorrectCount = totalQuestions - score;

        return (
          <div className="flex flex-col items-center justify-center h-full text-center">
            <h2 className="text-3xl md:text-4xl font-bold mb-2">Congratulations, {playerName}!</h2>
            <p className="text-xl text-slate-600 dark:text-slate-400 mb-6">You've completed the challenge.</p>

            <div className="bg-slate-100 dark:bg-slate-700 p-6 rounded-lg mb-6 w-full max-w-md">
              <p className="text-2xl font-bold">Your Score</p>
              <p className="text-6xl font-extrabold text-violet-600 dark:text-violet-400 my-2">
                {score} / {totalQuestions}
              </p>
              <p className="text-slate-600 dark:text-slate-400">
                That's {totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0}% correct!
              </p>
            </div>

            {mistakes.length > 0 ? (
              <div className="w-full max-w-md mb-6">
                <h3 className="text-xl font-bold mb-2">Review Your Mistakes</h3>
                <div className="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg max-h-40 overflow-y-auto text-left">
                  <ul className="space-y-2">
                    {mistakes.map((mistake) => (
                      <li key={mistake.rhyme} className="flex items-center justify-between p-2 bg-white dark:bg-slate-800 rounded">
                        <span className="font-semibold text-violet-700 dark:text-violet-300">{mistake.rhyme}</span>
                        <span className="text-slate-500 dark:text-slate-400">{mistake.pronunciationDisplay}</span>
                      </li>
                    ))}
                  </ul>
                </div>
                {incorrectCount > 10 && <p className="text-amber-600 dark:text-amber-400 mt-4">You had {incorrectCount} mistakes. Keep practicing by retrying them!</p>}
              </div>
            ) : (
              <p className="text-green-600 dark:text-green-400 font-semibold text-lg mb-6">Perfect score! You made zero mistakes!</p>
            )}

            <div className="flex flex-col sm:flex-row gap-4">
              {mistakes.length > 0 && (
                <button
                  onClick={onRetryMistakes}
                  className="px-6 py-3 text-lg font-bold text-white bg-amber-500 rounded-lg hover:bg-amber-600 transform hover:scale-105 transition-all duration-300 ease-in-out"
                >
                  Retry Mistakes ({mistakes.length})
                </button>
              )}
              <button
                onClick={onPlayAgain}
                className="px-6 py-3 text-lg font-bold text-white bg-violet-600 rounded-lg hover:bg-violet-700 transform hover:scale-105 transition-all duration-300 ease-in-out"
              >
                Play Again
              </button>
            </div>
          </div>
        );
      };

      // From components/GameScreen.tsx
      const shuffleArray = (array) => {
        return [...array].sort(() => Math.random() - 0.5);
      };

      const GameScreen = ({ rhymeFamilies, allWords, onGameFinish, allRhymeFamilies, isRetryMode = false }) => {
        const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
        const [score, setScore] = useState(0);
        const [mistakes, setMistakes] = useState([]);
        const [shuffledQuestions, setShuffledQuestions] = useState([]);
        
        const [voices, setVoices] = useState([]);
        const [selectedVoice, setSelectedVoice] = useState(null);
        
        const [foundWords, setFoundWords] = useState([]);
        const [isQuestionFailed, setIsQuestionFailed] = useState(false);
        const [showFeedback, setShowFeedback] = useState({});
        const [mistakeExplanation, setMistakeExplanation] = useState(null);

        useEffect(() => {
          ttsService.getVoices().then(availableVoices => {
            const englishVoices = availableVoices.filter(v => v.lang.startsWith('en'));
            setVoices(englishVoices);
            setSelectedVoice(englishVoices.find(v => v.name.includes('Google US English')) || englishVoices[0] || null);
          });
          setShuffledQuestions(shuffleArray(rhymeFamilies));
        }, [rhymeFamilies]);

        const currentRhymeFamily = useMemo(() => shuffledQuestions[currentQuestionIndex], [shuffledQuestions, currentQuestionIndex]);

        const currentWords = useMemo(() => {
          if (!currentRhymeFamily) return [];
          
          const correctWords = currentRhymeFamily.words;
          const distractorWords = shuffleArray(allWords.filter(w => !correctWords.some(cw => cw.text === w.text)))
            .slice(0, 4);
          
          return shuffleArray([...correctWords, ...distractorWords]);
        }, [currentRhymeFamily, allWords]);
        
        const speak = useCallback((text, rate = 0.9) => {
          ttsService.speak(text, selectedVoice, rate);
        }, [selectedVoice]);

        useEffect(() => {
          if (currentRhymeFamily) {
            speak(currentRhymeFamily.pronunciationSpeakable, 1.0);
          }
        }, [currentRhymeFamily, speak]);

        const handleNextQuestion = useCallback(() => {
          if (currentQuestionIndex < shuffledQuestions.length - 1) {
            setCurrentQuestionIndex(prev => prev + 1);
            setFoundWords([]);
            setIsQuestionFailed(false);
            setShowFeedback({});
            setMistakeExplanation(null);
          } else {
            onGameFinish(score, mistakes);
          }
        }, [currentQuestionIndex, shuffledQuestions.length, onGameFinish, score, mistakes]);

        useEffect(() => {
          if (currentRhymeFamily && foundWords.length > 0 && foundWords.length === currentRhymeFamily.words.length) {
            const timeoutId = setTimeout(() => {
                handleNextQuestion();
            }, 3000);
            return () => clearTimeout(timeoutId);
          }
        }, [foundWords, currentRhymeFamily, handleNextQuestion]);

        const handleWordClick = (word) => {
          if (foundWords.includes(word.text)) {
            return;
          }
          
          const isCorrect = currentRhymeFamily.words.some(w => w.text === word.text);

          setShowFeedback(prev => ({...prev, [word.text]: isCorrect ? 'correct' : 'incorrect'}));
          setTimeout(() => setShowFeedback(prev => {
              const newFeedback = {...prev};
              delete newFeedback[word.text];
              return newFeedback;
          }), 1000);

          if (isCorrect) {
            setMistakeExplanation(null);
            setFoundWords(prev => [...prev, word.text]);
            if (!isQuestionFailed) {
              setScore(prev => prev + 1);
            }
            speak(word.text);
            setTimeout(() => speak(word.text), 1000);
          } else {
            const incorrectFamily = allRhymeFamilies.find(family => 
              family.words.some(w => w.text === word.text)
            );

            if (incorrectFamily) {
              setMistakeExplanation(`Oops! "${word.text}" has the "${incorrectFamily.rhyme}" sound (${incorrectFamily.pronunciationDisplay}). We're looking for the "${currentRhymeFamily.rhyme}" sound (${currentRhymeFamily.pronunciationDisplay}).`);
            } else {
              setMistakeExplanation(`That's not it. The word "${word.text}" doesn't have the sound we're looking for. Try again!`);
            }

            if (!isQuestionFailed) {
              setMistakes(prev => {
                if (!prev.find(m => m.rhyme === currentRhymeFamily.rhyme)) {
                  return [...prev, currentRhymeFamily];
                }
                return prev;
              });
              setIsQuestionFailed(true);
            }
          }
        };

        if (!currentRhymeFamily) {
          return <div className="text-center p-8">Loading game...</div>;
        }

        const progress = (currentQuestionIndex / shuffledQuestions.length) * 100;

        return (
          <div className="flex flex-col h-full">
            <header className="mb-4">
              <div className="flex justify-between items-center mb-2">
                <div className="text-lg font-bold">
                  Score: <span className="text-green-500">{score}</span> / {shuffledQuestions.length}
                </div>
                <div className="w-1/3">
                  <select 
                    value={selectedVoice?.voiceURI} 
                    onChange={(e) => setSelectedVoice(voices.find(v => v.voiceURI === e.target.value) || null)}
                    className="w-full p-2 text-sm bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md outline-none"
                  >
                    {voices.map(voice => (
                      <option key={voice.voiceURI} value={voice.voiceURI}>{voice.name} ({voice.lang})</option>
                    ))}
                  </select>
                </div>
              </div>
              <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5">
                <div className="bg-violet-600 h-2.5 rounded-full" style={{ width: `${progress}%`, transition: 'width 0.5s' }}></div>
              </div>
            </header>

            <div 
              className="bg-violet-100 dark:bg-violet-900 border-2 border-violet-400 p-4 rounded-xl text-center mb-6"
            >
              <p className="text-sm text-slate-500 dark:text-slate-400">Click the words with this sound:</p>
              <div className="flex items-center justify-center gap-4">
                  <h2 className="text-3xl font-bold text-violet-700 dark:text-violet-300">{currentRhymeFamily.rhyme}</h2>
                  <p className="text-2xl text-slate-600 dark:text-slate-400">{currentRhymeFamily.pronunciationDisplay}</p>
                  <button onClick={() => speak(currentRhymeFamily.pronunciationSpeakable)} className="text-violet-500 hover:text-violet-700 dark:hover:text-violet-300">
                      <SpeakerIcon className="w-6 h-6"/>
                  </button>
              </div>
              <p className="text-sm text-slate-600 dark:text-slate-400 mt-2 italic">{currentRhymeFamily.explanation}</p>
            </div>

            {mistakeExplanation && (
              <div className="bg-amber-100 dark:bg-amber-900/50 border-l-4 border-amber-500 text-amber-800 dark:text-amber-200 p-4 my-4 rounded-r-lg" role="alert">
                <p className="font-bold">Not Quite!</p>
                <p>{mistakeExplanation}</p>
              </div>
            )}

            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 flex-grow">
              {currentWords.map(word => (
                <WordButton
                  key={word.text} 
                  word={word}
                  onClick={handleWordClick}
                  isFound={foundWords.includes(word.text)}
                  feedback={showFeedback[word.text]}
                />
              ))}
            </div>
            {currentRhymeFamily && foundWords.length === currentRhymeFamily.words.length && (
              <div className="mt-4 text-center">
                  <button 
                      onClick={handleNextQuestion}
                      className="px-6 py-2 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors"
                  >
                      Next
                  </button>
              </div>
            )}
          </div>
        );
      };

      // From App.tsx
      const App = () => {
        const [gameState, setGameState] = useState(GameState.Start);
        const [playerName, setPlayerName] = useState('');
        const [score, setScore] = useState(0);
        const [mistakes, setMistakes] = useState([]);
        const [totalQuestions, setTotalQuestions] = useState(0);

        const allRhymeFamiliesWithExplanations = useMemo(() => {
          return wordData.flatMap(group => 
            group.rhymeFamilies.map(rf => ({
              ...rf,
              explanation: group.explanation,
            }))
          );
        }, []);

        const allWords = useMemo(() => wordData.flatMap(group => group.rhymeFamilies.flatMap(rf => rf.words)), []);

        const handleGameStart = useCallback((name) => {
          setPlayerName(name);
          setScore(0);
          setMistakes([]);
          setTotalQuestions(allRhymeFamiliesWithExplanations.length);
          setGameState(GameState.Playing);
        }, [allRhymeFamiliesWithExplanations.length]);
        
        const handleGameFinish = useCallback((finalScore, finalMistakes) => {
          setScore(finalScore);
          setMistakes(finalMistakes);
          setGameState(GameState.Finished);
        }, []);
        
        const handlePlayAgain = useCallback(() => {
          handleGameStart(playerName);
        }, [playerName, handleGameStart]);

        const handleRetryMistakes = useCallback(() => {
          setScore(0);
          setTotalQuestions(mistakes.length);
          setGameState(GameState.Retrying);
        }, [mistakes.length]);

        const renderGameState = () => {
          switch (gameState) {
            case GameState.Start:
              return <StartScreen onStart={handleGameStart} />;
            case GameState.Playing:
              return <GameScreen rhymeFamilies={allRhymeFamiliesWithExplanations} allWords={allWords} onGameFinish={handleGameFinish} allRhymeFamilies={allRhymeFamiliesWithExplanations} />;
            case GameState.Retrying:
              return <GameScreen rhymeFamilies={mistakes} allWords={allWords} onGameFinish={handleGameFinish} isRetryMode={true} allRhymeFamilies={allRhymeFamiliesWithExplanations} />;
            case GameState.Finished:
              return (
                <EndScreen
                  playerName={playerName}
                  score={score}
                  totalQuestions={totalQuestions}
                  mistakes={mistakes}
                  onPlayAgain={handlePlayAgain}
                  onRetryMistakes={handleRetryMistakes}
                />
              );
            default:
              return <StartScreen onStart={handleGameStart} />;
          }
        };

        return (
          <div className="min-h-screen bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 flex flex-col items-center justify-center p-4 font-sans">
            <div className="w-full max-w-4xl mx-auto">
              <header className="text-center mb-6">
                <h1 className="text-4xl md:text-5xl font-bold text-violet-600 dark:text-violet-400">Magic E Rhyme Practice</h1>
                <p className="text-lg text-slate-600 dark:text-slate-400 mt-2">Master English pronunciation with this interactive game!</p>
              </header>
              <main className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-8 min-h-[500px] flex flex-col">
                {renderGameState()}
              </main>
              <footer className="text-center mt-6 text-slate-500 dark:text-slate-400">
                <p>Built with React and Tailwind CSS.</p>
              </footer>
            </div>
          </div>
        );
      };

      // From index.tsx
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <StrictMode>
          <App />
        </StrictMode>
      );
    </script>
  </body>
</html>
